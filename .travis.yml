dist: xenial

language: bash

services:
  - docker

before_install:
  - sudo apt-get install -y coreutils quilt parted qemu-user-static debootstrap zerofree zip dosfstools bsdtar libcap2-bin grep rsync xz-utils file git curl jq

script:
  - if [[ -f work/.cache/cache.tar ]]; then sudo tar -xf work/.cache/cache.tar ; fi
  - if [[ -d work/Raspbian-HOOBS/stage0/rootfs ]]; then touch stage0/SKIP ; fi
  - if [[ -d work/Raspbian-HOOBS/stage1/rootfs ]]; then touch stage1/SKIP ; fi
  - if [[ -d work/Raspbian-HOOBS/stage2/rootfs ]]; then touch stage2/SKIP ; fi
  - sudo CLEAN=1 ./build.sh -c config
  - sudo chown -R $USER:$USER deploy
  - sudo mv deploy/image_Raspbian-HOOBS.zip deploy/Raspbian-HOOBS.zip
  - rm -rf stage0/SKIP stage1/SKIP stage2/SKIP
  - sudo tar -cf work/.cache/cache.tar work/Raspbian-HOOBS/stage0 work/Raspbian-HOOBS/stage1 work/Raspbian-HOOBS/stage2

cache:
  timeout: 1000
  directories:
    - $TRAVIS_BUILD_DIR/work/.cache
  before_cache:
    - ls -la $TRAVIS_BUILD_DIR/work/.cache
    - sudo chown -R $USER:$USER $TRAVIS_BUILD_DIR/work/.cache

deploy:
  provider: releases
  api_key:
    secure: Z9qPgdJjfrITYm3TEorePYg/SYu4ubA1rZZVe+1WbQ6abwABNbv4dQb/3HBHZsMntVnZ1GfCwt56SSJCMIud7Jz4tSfLHxg5Sm0pxW0l9s7D+aT6TxKkUryebStraRFzXEd0kSQiMgJrx7MuBFFrZpxRZqX6at4/tn0NfX3SDOdbxG6jDp4vY9d9QqmJzPlB0PcTQE2HCfpwJf6VWsxws+oz74J4dRQzJ10/MfYv28SRey0Y25jSQIrV20JcAXHmG6oDAQoJA07FNXKKDma9utM8+0XEKpSRVgzBEjO9+aS0OdLoxXhKkufZiHefOEAgazJW7k0m1qulcH/xEVx0jpEjesfKh4nXHsYQ3NGgwjPLnaQKAo3c4Ev0vGdSLFnYj12uSxAkZA4hP4cCgWPZCzNfeW/5yEb/Q88sZk5l5+imtkSjY5/bTxyLEzFelRV6cJZCMU1KnRckwr6lwQ9AcBXduLNZURz6IBpKryJZO10ZKHY/1fEY4l8IEY9fGYPWiwkF7jITpwxT4gxBJ5Zdu2ZJEhJDeC2IyZ/6DEb2v4ZAIDPuRHTisHKP4fQuB3h/qt/DDYWOAL/JJBJhpMLuM8I95uGgFe/OXDK0ud/5Or05dx4SWshNOx12oqLXwyMrCSCwGNGII7bj9Fc7vt9BR3p8TurX7ZlgYDnC68ef4To=
  file: deploy/Raspbian-HOOBS.zip
  skip_cleanup: true
  on:
    repo: hoobs-org/rpi-image
    tags: true
